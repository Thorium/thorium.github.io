<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <!-- 
      The OWIN-rajapinta ja SignalR-viestitys.
 parameters will be replaced with the 
      document title extracted from the <h1> element or
      file name, if there is no <h1> heading
    -->
    <title>OWIN-rajapinta ja SignalR-viestitys.
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="http://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="content/style.css" />
    <script src="content/tips.js" type="text/javascript"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="row" style="margin-top:30px">
        <div class="span1"></div>
        <div class="span10" id="main">
          <h1>OWIN-rajapinta ja SignalR-viestitys.</h1>

<p><a href="http://owin.org/">OWIN</a> on rajapinta, johon voi helposti rekisteröidä komponentteja:</p>

<ul>
<li>WWW-tiedosto-palvelin</li>
<li>REST-Web-rajapintaa</li>
<li><a href="http://signalr.net/">SignalR</a>-kommunikaatio</li>
<li>Autentikointi</li>
<li>Yms. (tulevaisuudessa jopa IIS)</li>
</ul>

<p>OWIN ja SignalR vaativat käynnistyäkseen vähän infrastruktuuri-seremoniaa. 
Käytetään WorkerRole-projektia ja tiedostopalvelimena komponenttia Microsoft.Owin.StaticFiles.</p>

<h2>Käynnistyskoodilohkon lisääminen</h2>

<p>Valitse WorkerRole-projekti, paina sen päällä hiiren oikeaa nappia, ja valitse Add -> New Item... -> Source File, ja lisää projektille tiedosto MyStartUp.fs</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">module</span> <span class="i">MyStartUp</span>

<span class="k">open</span> <span class="i">Owin</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">Microsoft</span><span class="o">.</span><span class="i">AspNet</span><span class="o">.</span><span class="i">SignalR</span>

<span class="k">let</span> <span class="i">hubConfig</span> <span class="o">=</span> <span class="i">HubConfiguration</span>(<span class="i">EnableDetailedErrors</span> <span class="o">=</span> <span class="k">true</span>, <span class="i">EnableJavaScriptProxies</span> <span class="o">=</span> <span class="k">true</span>)

<span class="k">type</span> <span class="i">MyWebStartup</span>() <span class="o">=</span>
    <span class="k">member</span> <span class="i">x</span><span class="o">.</span><span class="i">Configuration</span>(<span class="i">app</span><span class="o">:</span><span class="i">Owin</span><span class="o">.</span><span class="i">IAppBuilder</span>) <span class="o">=</span>
        <span class="c">//OWIN Component registrations here...</span>

        <span class="c">//SignalR:</span>
        <span class="i">app</span><span class="o">.</span><span class="i">MapSignalR</span>(<span class="i">hubConfig</span>) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">ignore</span>            

        <span class="c">//Static files server (Note: default FileSystem is current directory!)</span>
        <span class="k">let</span> <span class="i">fileServerOptions</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs1', 3)" onmouseover="showTip(event, 'fs1', 3)" class="i">Microsoft</span><span class="o">.</span><span class="i">Owin</span><span class="o">.</span><span class="i">StaticFiles</span><span class="o">.</span><span class="i">FileServerOptions</span>()
        <span class="i">fileServerOptions</span><span class="o">.</span><span class="i">DefaultFilesOptions</span><span class="o">.</span><span class="i">DefaultFileNames</span><span class="o">.</span><span class="i">Add</span>(<span class="s">&quot;</span><span class="s">index</span><span class="s">.</span><span class="s">html</span><span class="s">&quot;</span>)
        <span class="c">//fileServerOptions.FileSystem &lt;- Microsoft.Owin.FileSystems.PhysicalFileSystem(@&quot;c:\wwwroot\&quot;)</span>
        <span class="i">app</span><span class="o">.</span><span class="i">UseFileServer</span> <span class="i">fileServerOptions</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 4)" onmouseover="showTip(event, 'fs2', 4)" class="i">ignore</span>

        ()

[&lt;<span class="i">assembly</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs1', 5)" onmouseover="showTip(event, 'fs1', 5)" class="i">Microsoft</span><span class="o">.</span><span class="i">Owin</span><span class="o">.</span><span class="i">OwinStartup</span>(<span onmouseout="hideTip(event, 'fs3', 6)" onmouseover="showTip(event, 'fs3', 6)" class="i">typeof</span><span class="o">&lt;</span><span class="i">MyWebStartup</span><span class="o">&gt;</span>)&gt;]
<span class="k">do</span>()</pre>
</td>
</tr>
</table>

<p>Siirrä kyseinen tiedosto Solution Explorerissa WorkerRole.fs-tiedoston päälle, jotta sen suoritus tapahtuu ennen WorkerRole-tiedostoa.</p>

<h3>Index.html</h3>

<p>Koodissa lisätään index.html www-palvelun oletustiedostoksi.
Oletuspolku palvelulle on projektin output-path. Joten lisää projektiin TextFile nimeltään index.html ja vaihda sen propertiesista "Build Action" arvoon "Content" ja "Copy to Output Folder" arvoon "Copy if newer".</p>

<p><img src="1-SolutionExplorer.png" alt="" /></p>

<p>Index.html tulee sisältämään jonkinlaisen sisällön ja kansan JavaScriptiä: SignalR-javascript-puolen komponentit. Mutta hommaa voi testata, niin voit nyt aluksi vaan kirjottaa sinne jonkinlaisen tervehdyksen.</p>

<h2>Konfiguraatio ja käynnistys</h2>

<p>Deployment-projektissa on <strong>ServerDefinition.csdef</strong>-tiedosto, jossa on palvelimen asetuksia. Aluksi voit muuttaa WorkerRole-tagin attribuutin vmsize-asetuksen asennosta "Small" asentoon "ExtraSmall". WorkerRole-tagin sisässä on Imports. Kopioi Imports:in rinnalle uusi tagi <strong>Endpoints</strong>. Tiedosto näyttää jokseenkin tältä (riippuen tietysti projektisi nimestä, yms.):</p>

<pre lang="xml"><span class="prep">&lt;?</span>xml version=<span class="s">"1.0"</span> encoding=<span class="s">"utf-8"</span><span class="prep">?&gt;</span>
<span class="k">&lt;</span><span class="i">ServiceDefinition</span> <span class="o">name</span><span class="k">="FSharpAzure"</span>
<span class="o">xmlns</span><span class="k">="http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition"</span> <span class="o">schemaVersion</span><span class="k">="2013-10.2.2"</span><span class="k">&gt;</span>
  <span class="k">&lt;</span><span class="i">WorkerRole</span> <span class="o">name</span><span class="k">="WorkerRole1"</span> <span class="o">vmsize</span><span class="k">="ExtraSmall"</span><span class="k">&gt;</span>
    <span class="k">&lt;</span><span class="i">Imports</span><span class="k">&gt;</span>
      <span class="k">&lt;</span><span class="i">Import</span> <span class="o">moduleName</span><span class="k">="Diagnostics"</span> <span class="k">/&gt;</span>
    <span class="k">&lt;/</span><span class="i">Imports</span><span class="k">&gt;</span>
    <span class="k">&lt;</span><span class="i">Endpoints</span><span class="k">&gt;</span>
      <span class="k">&lt;</span><span class="i">InputEndpoint</span> <span class="o">name</span><span class="k">="Endpoint1"</span> <span class="o">protocol</span><span class="k">="http"</span> <span class="o">port</span><span class="k">="80"</span> <span class="o">localPort</span><span class="k">="80"</span> <span class="k">/&gt;</span>
    <span class="k">&lt;/</span><span class="i">Endpoints</span><span class="k">&gt;</span>
  <span class="k">&lt;/</span><span class="i">WorkerRole</span><span class="k">&gt;</span>
<span class="k">&lt;/</span><span class="i">ServiceDefinition</span><span class="k">&gt;</span></pre>

<p>Seuraavaksi avaa WorkerRole.fs:n tiedosto wr.OnStart() -metodi ja kopioi ennen base.OnStart():ia tapahtumaan seuraava koodinpätkä:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span class="i">endpoint</span> <span class="o">=</span> <span class="i">RoleEnvironment</span><span class="o">.</span><span class="i">CurrentRoleInstance</span><span class="o">.</span><span class="i">InstanceEndpoints</span><span class="o">.</span>[<span class="s">&quot;</span><span class="s">Endpoint1</span><span class="s">&quot;</span>]
<span class="k">let</span> <span class="i">baseUri</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 7)" onmouseover="showTip(event, 'fs4', 7)" class="i">sprintf</span> <span class="s">&quot;</span><span class="s">%</span><span class="s">s</span><span class="s">:</span><span class="s">/</span><span class="s">/</span><span class="s">%</span><span class="s">A</span><span class="s">&quot;</span> <span class="i">endpoint</span><span class="o">.</span><span class="i">Protocol</span> <span class="i">endpoint</span><span class="o">.</span><span class="i">IPEndpoint</span>
<span onmouseout="hideTip(event, 'fs5', 8)" onmouseover="showTip(event, 'fs5', 8)" class="i">log</span> (<span class="s">&quot;</span><span class="s">Starting</span><span class="s"> </span><span class="s">OWIN</span><span class="s"> </span><span class="s">at</span><span class="s"> </span><span class="s">&quot;</span> <span class="o">+</span> <span class="i">baseUri</span>) <span class="s">&quot;</span><span class="s">Information</span><span class="s">&quot;</span>
<span class="k">let</span> <span class="i">options</span> <span class="o">=</span> <span class="i">StartOptions</span>()
<span class="i">options</span><span class="o">.</span><span class="i">Urls</span><span class="o">.</span><span class="i">Add</span>(<span class="i">baseUri</span>)
<span class="i">webApp</span> <span class="o">&lt;-</span> <span class="i">WebApp</span><span class="o">.</span><span class="i">Start</span><span class="o">&lt;</span><span class="i">MyStartUp</span><span class="o">.</span><span class="i">MyWebStartup</span><span class="o">&gt;</span>(<span class="i">options</span>)</pre>
</td>
</tr>
</table>

<p>Tämä hakee konfiguraation ServerDefinition-tiedostosta, tulostaa sen ruudulle, ja käynnistää palvelimen. Nyt kun käynnistät palvelimen, niin voit käydä Azuren Compute Emulator UI:n konsolista katsomassa (tähän oli ohjeet jo WorkerRole-harjoituksessa) mihin osoitteeseen palvelin käynnistyi, ja surffata siihen selaimella.</p>

<p><img src="2-StaticFileServer.png" alt="" /></p>

<h2>Signal-R</h2>

<p>Tämän osion materiaali ei ole vielä valmis...</p>

<p><a href="../Readme.html">Takaisin valikkoon</a></p>

          <div class="tip" id="fs1">namespace Microsoft</div>
<div class="tip" id="fs2">val ignore : value:&#39;T -&gt; unit<br /><br />Full name: Microsoft.FSharp.Core.Operators.ignore</div>
<div class="tip" id="fs3">val typeof&lt;&#39;T&gt; : System.Type<br /><br />Full name: Microsoft.FSharp.Core.Operators.typeof</div>
<div class="tip" id="fs4">val sprintf : format:Printf.StringFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.sprintf</div>
<div class="tip" id="fs5">val log : value:&#39;T -&gt; &#39;T (requires member Log)<br /><br />Full name: Microsoft.FSharp.Core.Operators.log</div>
          
        </div>
        <div class="span1"></div>
      </div>
    </div>
  </body>
</html>