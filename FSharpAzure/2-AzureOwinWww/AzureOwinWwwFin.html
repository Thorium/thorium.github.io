<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <!-- 
      The OWIN-rajapinta ja SignalR-viestitys
 parameters will be replaced with the 
      document title extracted from the <h1> element or
      file name, if there is no <h1> heading
    -->
    <title>OWIN-rajapinta ja SignalR-viestitys
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="../content/style.css" />
	<meta name="robots" content="index,follow" />
	<meta name="rating" content="general" />
	<meta name="generator" content="FSharp.Formatting.2.4.2 by Tomas Petricek" />
	<meta name="Author" content="Tuomas Hietanen, 2014" />
    <script src="../content/tips.js" type="text/javascript"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
	<style type="text/css" id="custom-background-css">
		body { background-color: #E9E9E9; background-image: url('../content/FStAUS.png'); background-repeat: repeat; background-position: top left; background-attachment: fixed; }
		.container { background-color: #FFFFFF; border: solid 1px #000000; }
	</style>
  </head>
  <body class="bg">
	<div style="margin: 5px; text-align: center; color:gray;">
		<a href="http://www.meetup.com/FSharpHelsinki/" target="_blank"><span style="margin: 5px; text-align: center; color:gray;">The Greater Helsinki Area F# User Group</span></a>
		<span style="margin: 5px; text-align: center; color:gray;"> - F# & Azure - </span>
		<a href="http://thorium.github.io/FSharpAzure/Readme.html"><span style="margin: 5px; text-align: center; color:gray;">FI</span></a>	
		<a href="http://thorium.github.io/FSharpAzure/ReadmeEng.html"><span style="margin: 5px; text-align: center; color:gray;">EN</span></a>	
    </div>
	<div class="container">
      <div class="row" style="margin-top:30px">
        <div class="span1"></div>
        <div class="span10" id="main">
          <h1>OWIN-rajapinta ja SignalR-viestitys</h1>

<p><a href="http://owin.org/">OWIN</a> on rajapinta, johon voi helposti rekisteröidä komponentteja:</p>

<ul>
<li>WWW-tiedosto-palvelin</li>
<li>REST-Web-rajapintaa</li>
<li><a href="http://signalr.net/">SignalR</a>-kommunikaatio</li>
<li>Autentikointi</li>
<li>Yms. (tulevaisuudessa jopa IIS)</li>
</ul>

<p>OWIN ja SignalR vaativat käynnistyäkseen vähän infrastruktuuri-seremoniaa. 
Käytetään WorkerRole-projektia ja tiedostopalvelimena komponenttia Microsoft.Owin.StaticFiles.</p>

<h3>Tekniikkavalinta</h3>

<p>Tässä harjoituksessa on valittu tekniikaksi SignalR, jolla saavutetaan kaksisuuntainen kommunikaatio. Toinen tyypillinen tapa olisi tehdä CRUD-henkinen REST API, josta löytyy OWIN-F#-<a href="https://github.com/dmohl/FsOnTheWeb-Workshop/blob/master/Azure%20Lab/AzureFSharpOwinComplete/WebApiRole/GuitarsApi.fs">koodiesimerkki</a> netistä.</p>

<p>Tässä harjoituksessa käytetään WorkerRolea ja OWIN:ia. Toinen ihan käyttökelpoinen ratkaisu olisi tehdä (C#/VB.NET) ASPNET Web Role, josta voi referoida F#-kirjasto-projektia. Silloin saisit osan IIS-infrastruktuuria kaupanpäälle, mutta kannattaisi varautua mahdollisiin taustasäieongelmiin.</p>

<h2>Käynnistyskoodilohkon lisääminen</h2>

<p>Valitse WorkerRole-projekti, paina sen päällä hiiren oikeaa nappia, ja valitse Add -> New Item... -> Source File, ja lisää projektille tiedosto MyStartUp.fs sisällöltään:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">module</span> <span class="i">MyStartUp</span>

<span class="k">open</span> <span class="i">Owin</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">Microsoft</span><span class="o">.</span><span class="i">AspNet</span><span class="o">.</span><span class="i">SignalR</span>

<span class="k">let</span> <span class="i">hubConfig</span> <span class="o">=</span> <span class="i">HubConfiguration</span>(<span class="i">EnableDetailedErrors</span> <span class="o">=</span> <span class="k">true</span>, <span class="i">EnableJavaScriptProxies</span> <span class="o">=</span> <span class="k">true</span>)

<span class="k">type</span> <span class="i">MyWebStartup</span>() <span class="o">=</span>
    <span class="k">member</span> <span class="i">x</span><span class="o">.</span><span class="i">Configuration</span>(<span class="i">app</span><span class="o">:</span><span class="i">Owin</span><span class="o">.</span><span class="i">IAppBuilder</span>) <span class="o">=</span>
        <span class="c">//OWIN Component registrations here...</span>

        <span class="c">//SignalR:</span>
        <span class="i">app</span><span class="o">.</span><span class="i">MapSignalR</span>(<span class="i">hubConfig</span>) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">ignore</span>            

        <span class="c">//Static files server (Note: default FileSystem is current directory!)</span>
        <span class="k">let</span> <span class="i">fileServerOptions</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs1', 3)" onmouseover="showTip(event, 'fs1', 3)" class="i">Microsoft</span><span class="o">.</span><span class="i">Owin</span><span class="o">.</span><span class="i">StaticFiles</span><span class="o">.</span><span class="i">FileServerOptions</span>()
        <span class="i">fileServerOptions</span><span class="o">.</span><span class="i">DefaultFilesOptions</span><span class="o">.</span><span class="i">DefaultFileNames</span><span class="o">.</span><span class="i">Add</span>(<span class="s">&quot;</span><span class="s">index</span><span class="s">.</span><span class="s">html</span><span class="s">&quot;</span>)
        <span class="c">//fileServerOptions.FileSystem &lt;- Microsoft.Owin.FileSystems.PhysicalFileSystem(@&quot;c:\wwwroot\&quot;)</span>
        <span class="i">app</span><span class="o">.</span><span class="i">UseFileServer</span> <span class="i">fileServerOptions</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 4)" onmouseover="showTip(event, 'fs2', 4)" class="i">ignore</span>

        ()

[&lt;<span class="i">assembly</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs1', 5)" onmouseover="showTip(event, 'fs1', 5)" class="i">Microsoft</span><span class="o">.</span><span class="i">Owin</span><span class="o">.</span><span class="i">OwinStartup</span>(<span onmouseout="hideTip(event, 'fs3', 6)" onmouseover="showTip(event, 'fs3', 6)" class="i">typeof</span><span class="o">&lt;</span><span class="i">MyWebStartup</span><span class="o">&gt;</span>)&gt;]
<span class="k">do</span>()</pre>
</td>
</tr>
</table>

<p>Siirrä kyseinen tiedosto Solution Explorerissa WorkerRole.fs-tiedoston päälle, jotta sen suoritus tapahtuu ennen WorkerRole-tiedostoa.</p>

<h3>Index.html</h3>

<p>Koodissa lisätään index.html www-palvelun oletustiedostoksi.
Oletuspolku palvelulle on projektin output-path. Joten lisää projektiin TextFile nimeltään index.html ja vaihda sen propertiesista "Build Action" arvoon "Content" ja "Copy to Output Folder" arvoon "Copy if newer".</p>

<p><img src="1-SolutionExplorer.png" alt="" /></p>

<p>Index.html tulee sisältämään jonkinlaisen sisällön ja kansan JavaScriptiä: SignalR-JavaScript-asiakaspuolen komponentit. Mutta hommaa voi testata, niin voit nyt aluksi vaan kirjottaa sinne jonkinlaisen tervehdyksen.</p>

<h2>Konfiguraatio ja käynnistys</h2>

<p>Deployment-projektissa on <strong>ServerDefinition.csdef</strong>-tiedosto, jossa on palvelimen asetuksia. Aluksi voit muuttaa WorkerRole-tagin attribuutin vmsize-asetuksen asennosta "Small" asentoon "ExtraSmall". WorkerRole-tagin sisässä on Imports. Kopioi Imports:in rinnalle uusi tagi <strong>Endpoints</strong>. Tiedosto näyttää jokseenkin tältä (riippuen tietysti projektisi nimestä, yms.):</p>

<pre lang="xml"><span class="prep">&lt;?</span>xml version=<span class="s">"1.0"</span> encoding=<span class="s">"utf-8"</span><span class="prep">?&gt;</span>
<span class="k">&lt;</span><span class="i">ServiceDefinition</span> <span class="o">name</span><span class="k">="FSharpAzure"</span>
<span class="o">xmlns</span><span class="k">="http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition"</span> 
<span class="o">schemaVersion</span><span class="k">="2013-10.2.2"</span><span class="k">&gt;</span>
  <span class="k">&lt;</span><span class="i">WorkerRole</span> <span class="o">name</span><span class="k">="WorkerRole1"</span> <span class="o">vmsize</span><span class="k">="ExtraSmall"</span><span class="k">&gt;</span>
    <span class="k">&lt;</span><span class="i">Imports</span><span class="k">&gt;</span>
      <span class="k">&lt;</span><span class="i">Import</span> <span class="o">moduleName</span><span class="k">="Diagnostics"</span> <span class="k">/&gt;</span>
    <span class="k">&lt;/</span><span class="i">Imports</span><span class="k">&gt;</span>
    <span class="k">&lt;</span><span class="i">Endpoints</span><span class="k">&gt;</span>
      <span class="k">&lt;</span><span class="i">InputEndpoint</span> <span class="o">name</span><span class="k">="Endpoint1"</span> <span class="o">protocol</span><span class="k">="http"</span> <span class="o">port</span><span class="k">="80"</span> <span class="o">localPort</span><span class="k">="80"</span> <span class="k">/&gt;</span>
    <span class="k">&lt;/</span><span class="i">Endpoints</span><span class="k">&gt;</span>
  <span class="k">&lt;/</span><span class="i">WorkerRole</span><span class="k">&gt;</span>
<span class="k">&lt;/</span><span class="i">ServiceDefinition</span><span class="k">&gt;</span></pre>

<p>Seuraavaksi avaa WorkerRole.fs:n tiedosto wr.OnStart() -metodi ja kopioi ennen base.OnStart():ia tapahtumaan seuraava koodinpätkä:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span class="i">endpoint</span> <span class="o">=</span> <span class="i">RoleEnvironment</span><span class="o">.</span><span class="i">CurrentRoleInstance</span><span class="o">.</span><span class="i">InstanceEndpoints</span><span class="o">.</span>[<span class="s">&quot;</span><span class="s">Endpoint1</span><span class="s">&quot;</span>]
<span class="k">let</span> <span class="i">baseUri</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 7)" onmouseover="showTip(event, 'fs4', 7)" class="i">sprintf</span> <span class="s">&quot;</span><span class="s">%</span><span class="s">s</span><span class="s">:</span><span class="s">/</span><span class="s">/</span><span class="s">%</span><span class="s">A</span><span class="s">&quot;</span> <span class="i">endpoint</span><span class="o">.</span><span class="i">Protocol</span> <span class="i">endpoint</span><span class="o">.</span><span class="i">IPEndpoint</span>
<span onmouseout="hideTip(event, 'fs5', 8)" onmouseover="showTip(event, 'fs5', 8)" class="i">log</span> (<span class="s">&quot;</span><span class="s">Starting</span><span class="s"> </span><span class="s">OWIN</span><span class="s"> </span><span class="s">at</span><span class="s"> </span><span class="s">&quot;</span> <span class="o">+</span> <span class="i">baseUri</span>) <span class="s">&quot;</span><span class="s">Information</span><span class="s">&quot;</span>
<span class="k">let</span> <span class="i">options</span> <span class="o">=</span> <span class="i">StartOptions</span>()
<span class="i">options</span><span class="o">.</span><span class="i">Urls</span><span class="o">.</span><span class="i">Add</span>(<span class="i">baseUri</span>)
<span class="i">webApp</span> <span class="o">&lt;-</span> <span class="i">WebApp</span><span class="o">.</span><span class="i">Start</span><span class="o">&lt;</span><span class="i">MyStartUp</span><span class="o">.</span><span class="i">MyWebStartup</span><span class="o">&gt;</span>(<span class="i">options</span>)</pre>
</td>
</tr>
</table>

<p>Tämä hakee konfiguraation ServerDefinition-tiedostosta, tulostaa sen ruudulle, ja käynnistää palvelimen. Nyt kun käynnistät palvelimen, niin voit käydä Azuren Compute Emulator UI:n konsolista katsomassa (tähän oli ohjeet jo WorkerRole-harjoituksessa) mihin osoitteeseen palvelin käynnistyi, ja surffata siihen selaimella.</p>

<p><img src="2-StaticFileServer.png" alt="" /></p>

<h2>SignalR</h2>

<p>SignalR on dynaaminen JavaScriptiin perustuva kirjasto, joka käyttää C#-dynamic-operaattoria. Tämän takia WorkerRole-projektiin on <strong>lisättävä referenssi Microsoft.CSharp</strong>.
(Tuttuun tapaan, Solution Explorerissa References-kansion päällä oikeaa nappia ja: Add Reference -> Assemblies -> Framework).</p>

<p>Lisäksi dynamic ei toimi ihan sellaisenaan, joten lisää vielä uusi tiedosto Dynamic.fs ja siirrä se ensimmäiseksi ennen muita fs-tiedostoja, ja kopioi sen sisällöksi <a href="https://raw.githubusercontent.com/Thorium/CatVsDog/master/OwinWorkerRole/Dynamic.fs">tämä</a> sisältö, joka on otettu <a href="http://www.fssnip.net/raw/2U">Fssnip</a>-sitelta.</p>

<p>Lisätään ohjelmaksi pieni peli, jota voi testailla interactivessa:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="prep">#if</span> <span class="i">INTERACTIVE</span>
<span class="inactive">#r</span><span class="inactive"> </span><span class="inactive">&quot;../packages/FSharp.Data.2.0.5/lib/net40/FSharp.Data.dll&quot;</span>
<span class="prep">#endif</span>    
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs6', 9)" onmouseover="showTip(event, 'fs6', 9)" class="i">System</span>
<span class="k">open</span> <span class="i">FSharp</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 10)" onmouseover="showTip(event, 'fs7', 10)" class="i">Data</span>

<span class="k">let</span> <span class="i">bank</span> <span class="o">=</span> <span class="i">WorldBankData</span><span class="o">.</span><span class="i">GetDataContext</span>()
<span class="k">let</span> <span class="i">countries</span> <span class="o">=</span> <span class="i">bank</span><span class="o">.</span><span class="i">Regions</span><span class="o">.</span><span class="i">World</span><span class="o">.</span><span class="i">Countries</span>
                <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs8', 11)" onmouseover="showTip(event, 'fs8', 11)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs9', 12)" onmouseover="showTip(event, 'fs9', 12)" class="i">filter</span>(<span class="k">fun</span> <span class="i">i</span> <span class="k">-&gt;</span> <span class="i">i</span><span class="o">.</span><span class="i">CapitalCity</span> <span class="o">&lt;&gt;</span> <span class="s">&quot;</span><span class="s">&quot;</span>) 
                <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs8', 13)" onmouseover="showTip(event, 'fs8', 13)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 14)" onmouseover="showTip(event, 'fs10', 14)" class="i">map</span>(<span class="k">fun</span> <span class="i">i</span> <span class="k">-&gt;</span> <span class="i">i</span><span class="o">.</span><span class="i">Name</span>, <span class="i">i</span><span class="o">.</span><span class="i">CapitalCity</span>)
<span class="k">let</span> <span class="i">corrects</span> <span class="o">=</span> <span class="i">countries</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs8', 15)" onmouseover="showTip(event, 'fs8', 15)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs11', 16)" onmouseover="showTip(event, 'fs11', 16)" class="i">toArray</span>
<span class="k">let</span> <span class="i">rnd</span> <span class="o">=</span> <span class="i">Random</span>()
<span class="k">let</span> <span class="i">questionItem</span>() <span class="o">=</span> <span class="i">corrects</span><span class="o">.</span>[<span class="i">rnd</span><span class="o">.</span><span class="i">Next</span>(<span class="i">corrects</span><span class="o">.</span><span class="i">Length</span>)]

<span class="k">let</span> <span class="i">generateQuiz</span>() <span class="o">=</span>
    <span class="k">let</span> <span class="i">correct</span>, <span class="i">capitalCity</span> <span class="o">=</span> <span class="i">questionItem</span>()
    <span class="i">capitalCity</span>, [<span class="i">correct</span>; <span onmouseout="hideTip(event, 'fs12', 17)" onmouseover="showTip(event, 'fs12', 17)" class="i">fst</span>(<span class="i">questionItem</span>()); <span onmouseout="hideTip(event, 'fs12', 18)" onmouseover="showTip(event, 'fs12', 18)" class="i">fst</span>(<span class="i">questionItem</span>())] <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs13', 19)" onmouseover="showTip(event, 'fs13', 19)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 20)" onmouseover="showTip(event, 'fs14', 20)" class="i">sort</span>

<span class="k">let</span> <span class="i">checkAnswer</span> <span class="i">country</span> <span class="i">capitalCity</span> <span class="o">=</span>
    <span class="i">corrects</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs15', 21)" onmouseover="showTip(event, 'fs15', 21)" class="i">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 22)" onmouseover="showTip(event, 'fs16', 22)" class="i">exists</span>(<span class="k">fun</span> (<span class="i">cou</span>, <span class="i">cap</span>) <span class="k">-&gt;</span> <span class="i">cou</span> <span class="o">=</span> <span class="i">country</span> <span class="o">&amp;&amp;</span> <span class="i">cap</span> <span class="o">=</span> <span class="i">capitalCity</span>)</pre>
</td>
</tr>
</table>

<p>Lisätään vielä pari apumetodia ja yksi apuluokka, joka mallintaa JSON-liikenteen muotoa:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span class="i">preGenerated</span> <span class="o">=</span> [<span class="n">0..</span><span class="n">500</span>] <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs13', 23)" onmouseover="showTip(event, 'fs13', 23)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 24)" onmouseover="showTip(event, 'fs17', 24)" class="i">map</span>(<span class="k">fun</span> _ <span class="k">-&gt;</span> <span class="i">generateQuiz</span>())
<span class="k">let</span> <span class="i">takeNth</span> <span class="i">n</span> <span class="o">=</span> <span class="i">preGenerated</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs8', 25)" onmouseover="showTip(event, 'fs8', 25)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs18', 26)" onmouseover="showTip(event, 'fs18', 26)" class="i">skip</span> <span class="i">n</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs8', 27)" onmouseover="showTip(event, 'fs8', 27)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 28)" onmouseover="showTip(event, 'fs19', 28)" class="i">head</span>

<span class="k">type</span> <span class="i">QuizItem</span>(<span class="i">quizId</span>)<span class="o">=</span>
    <span class="k">let</span> <span class="i">item</span> <span class="o">=</span> <span class="i">takeNth</span> <span class="i">quizId</span>
    <span class="k">member</span> <span class="i">x</span><span class="o">.</span><span class="i">QuizId</span> <span class="o">=</span> <span class="i">quizId</span>
    <span class="k">member</span> <span class="i">x</span><span class="o">.</span><span class="i">Capital</span> <span class="o">=</span> <span class="i">item</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs12', 29)" onmouseover="showTip(event, 'fs12', 29)" class="i">fst</span>
    <span class="k">member</span> <span class="i">x</span><span class="o">.</span><span class="i">Countries</span> <span class="o">=</span> <span class="i">item</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs20', 30)" onmouseover="showTip(event, 'fs20', 30)" class="i">snd</span></pre>
</td>
</tr>
</table>

<p>Sitten tarvitaan luokka, joka periytyy SignalR-kantaluokasta. Se näyttäköön tältä:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 31)" onmouseover="showTip(event, 'fs1', 31)" class="i">Microsoft</span><span class="o">.</span><span class="i">AspNet</span><span class="o">.</span><span class="i">SignalR</span>
<span class="k">open</span> <span class="i">Dynamic</span>

<span class="k">type</span> <span class="i">CountryHub</span>() <span class="o">=</span>
    <span class="k">inherit</span> <span class="i">Hub</span>()

    <span class="k">override</span> <span class="i">this</span><span class="o">.</span><span class="i">OnConnected</span>() <span class="o">=</span>
        <span class="k">base</span><span class="o">.</span><span class="i">OnConnected</span>() <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 32)" onmouseover="showTip(event, 'fs2', 32)" class="i">ignore</span>
        <span class="i">QuizItem</span>(<span class="i">rnd</span><span class="o">.</span><span class="i">Next</span>(<span class="n">500</span>)) <span class="o">|&gt;</span> <span class="i">this</span><span class="o">.</span><span class="i">Clients</span><span class="o">.</span><span class="i">Caller</span><span class="o">?</span><span class="i">newQuiz</span>

    <span class="k">member</span> <span class="i">this</span><span class="o">.</span><span class="i">GuessCountry</span>(<span class="i">quizzId</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs21', 33)" onmouseover="showTip(event, 'fs21', 33)" class="i">int</span>, <span class="i">country</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs22', 34)" onmouseover="showTip(event, 'fs22', 34)" class="i">string</span>)<span class="o">:</span><span onmouseout="hideTip(event, 'fs23', 35)" onmouseover="showTip(event, 'fs23', 35)" class="i">unit</span> <span class="o">=</span>
        <span class="k">let</span> <span class="i">capital</span> <span class="o">=</span> <span class="i">takeNth</span> <span class="i">quizzId</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs12', 36)" onmouseover="showTip(event, 'fs12', 36)" class="i">fst</span>
        <span class="k">match</span> <span class="i">checkAnswer</span> <span class="i">country</span> <span class="i">capital</span> <span class="k">with</span>
        | <span class="k">true</span> <span class="k">-&gt;</span>
            <span class="i">this</span><span class="o">.</span><span class="i">Clients</span><span class="o">.</span><span class="i">Caller</span><span class="o">?</span><span class="i">informResult</span>(<span class="s">&quot;</span><span class="s">Correct</span><span class="s">!</span><span class="s">&quot;</span>) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 37)" onmouseover="showTip(event, 'fs2', 37)" class="i">ignore</span>
            <span class="i">QuizItem</span>(<span class="i">rnd</span><span class="o">.</span><span class="i">Next</span>(<span class="n">500</span>)) <span class="o">|&gt;</span> <span class="i">this</span><span class="o">.</span><span class="i">Clients</span><span class="o">.</span><span class="i">Caller</span><span class="o">?</span><span class="i">newQuiz</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 38)" onmouseover="showTip(event, 'fs2', 38)" class="i">ignore</span>
            <span class="c">//this.Clients.All?informResult(&quot;Correct found&quot;)</span>
        | <span class="k">false</span> <span class="k">-&gt;</span>
            <span class="i">this</span><span class="o">.</span><span class="i">Clients</span><span class="o">.</span><span class="i">Caller</span><span class="o">?</span><span class="i">informResult</span>(<span class="s">&quot;</span><span class="s">Wrong</span><span class="s">!</span><span class="s"> </span><span class="s">Try</span><span class="s"> </span><span class="s">again</span><span class="s">!</span><span class="s">&quot;</span>) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 39)" onmouseover="showTip(event, 'fs2', 39)" class="i">ignore</span></pre>
</td>
</tr>
</table>

<ul>
<li>GuessCountry-metodia kutsutaan JavaScript-clientista.</li>
<li>newQuiz ja informResult taas ovat JavaScriptissä määriteltyjä funktioita, joita kutsutaan tästä. Kysymysmerkki on dynaaminen operaattori, joka tulee Dynamics.fs-koodista.</li>
</ul>

<p>Nuget-asennuspaketti on lisännyt WorkerRole-projektiin Scripts-hakemiston. Koska SignalR käyttää jQueryä ja SignalR:n omaa JavaScript-clienttia, niin käy vaihtamassa näille kahdelle tiedostolle "Copy to Output Directory" arvoon "Copy if newer": jquery-1.6.4.min.js ja jquery.signalR-2.0.3.min.js</p>

<ul>
<li>Tiedostojen versionumerot voivat vaihdella riippuen siitä, mitkä paketit NuGet hakee. Vastaaviin viitataan Index.html-tiedostossa. Viittausten on oltava samat.</li>
</ul>

<p>Tarvitset vielä sisällön Index.html-tiedostolle:</p>

<pre lang="html"><span class="k">&lt;!</span><span class="i">DOCTYPE</span> <span class="o">html</span><span class="k">&gt;</span>
<span class="k">&lt;</span><span class="i">html</span> <span class="o">xmlns</span><span class="k">="http://www.w3.org/1999/xhtml"</span> <span class="o">lang</span><span class="k">="en"</span><span class="k">&gt;</span>
<span class="k">&lt;</span><span class="i">head</span><span class="k">&gt;</span>
    <span class="k">&lt;</span><span class="i">meta</span> <span class="o">http-equiv</span><span class="k">="Content-Type"</span> <span class="o">content</span><span class="k">="text/html; charset=UTF-8"</span> <span class="k">/&gt;</span>
    <span class="k">&lt;</span><span class="i">meta</span> <span class="o">charset</span><span class="k">="UTF-8"</span> <span class="k">/&gt;</span>
    <span class="k">&lt;</span><span class="i">title</span><span class="k">&gt;</span>SignalR+F-Sharp<span class="k">&lt;/</span><span class="i">title</span><span class="k">&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">    &lt;script type="text/javascript"</span>
<span class="c">        src="https://code.jquery.com/jquery-1.6.4.min.js"&gt;&lt;/script&gt;</span>
<span class="c">    &lt;script type="text/javascript"</span>
<span class="c">        src="https://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.0.3.min.js"&gt;&lt;/script&gt;</span>
<span class="c">    --&gt;</span>
    &lt;script type=<span class="s">"text/javascript"</span> src=<span class="s">"Scripts/jquery-1.6.4.min.js"</span>&gt;&lt;/script&gt;
    &lt;script type=<span class="s">"text/javascript"</span> src=<span class="s">"Scripts/jquery.signalR-2.0.3.min.js"</span>&gt;&lt;/script&gt;
    &lt;script type=<span class="s">"text/javascript"</span> src=<span class="s">"/signalr/hubs"</span>&gt;&lt;/script&gt;
    &lt;script type=<span class="s">"text/javascript"</span>&gt;
        <span class="k">var</span> currentId;
        <span class="k">var</span> corrects = 0;
        <span class="k">var</span> wrongs = 0;
        $(document).ready(<span class="k">function</span> () {
            $(<span class="s">"#correctDisplay"</span>).text(0);

            <span class="c">//SignalR Hub:</span>
            <span class="k">var</span> myHub;
            $.connection.hub.url = <span class="s">"/signalr"</span>;
            myHub = $.connection.countryHub; <span class="c">//Hub class</span>
            <span class="k">if</span> (!myHub) console.log(<span class="s">"hub not found"</span>);

            myHub.client.newQuiz = <span class="k">function</span> (data) {
                currentId = data.QuizId;
                question.innerHTML = <span class="s">"Which country has the capital city of "</span> + data.Capital +<span class="s">"?"</span>;
                $(<span class="s">"#btn1"</span>).val(data.Countries[0]);
                $(<span class="s">"#btn2"</span>).val(data.Countries[1]);
                $(<span class="s">"#btn3"</span>).val(data.Countries[2]);
            };

            myHub.client.informResult = <span class="k">function</span> (data) {
                <span class="k">if</span> (data == <span class="s">"Correct!"</span>) $(<span class="s">"#correctDisplay"</span>).text(++corrects);
                <span class="k">else</span> alert(data);
            };

            $.connection.hub.logging = <span class="k">true</span>;
            $.connection.hub.start().
                done(<span class="k">function</span> () {
                    $(<span class="s">"#btn1"</span>).click(<span class="k">function</span> () {
                        myHub.server.guessCountry(currentId, $(<span class="s">"#btn1"</span>).val());
                        <span class="k">return</span> <span class="k">false</span>;
                    });
                    $(<span class="s">"#btn2"</span>).click(<span class="k">function</span> () {
                        myHub.server.guessCountry(currentId, $(<span class="s">"#btn2"</span>).val());
                        <span class="k">return</span> <span class="k">false</span>;
                    });
                    $(<span class="s">"#btn3"</span>).click(<span class="k">function</span> () {
                        myHub.server.guessCountry(currentId, $(<span class="s">"#btn3"</span>).val());
                        <span class="k">return</span> <span class="k">false</span>;
                    });
                });
        });
    <span class="k">&lt;/</span><span class="i">script</span><span class="k">&gt;</span>
    <span class="k">&lt;</span><span class="i">style</span><span class="k">&gt;</span>
        .bgFrame {
            background-color: #ffffff;
            border: thin solid #000000;
            padding: 30px;
            margin: 30px;
            width: 600px;
            height: 200px;
            vertical-align: middle;
            text-align: center;
        }
    <span class="k">&lt;/</span><span class="i">style</span><span class="k">&gt;</span>
<span class="k">&lt;/</span><span class="i">head</span><span class="k">&gt;</span>

<span class="k">&lt;</span><span class="i">body</span> <span class="o">style</span><span class="k">="background-color: #46c0b8"</span><span class="k">&gt;</span>
    <span class="k">&lt;</span><span class="i">div</span> <span class="o">class</span><span class="k">="bgFrame"</span><span class="k">&gt;</span>
        <span class="k">&lt;</span><span class="i">h2</span><span class="k">&gt;</span>Country Quiz<span class="k">&lt;/</span><span class="i">h2</span><span class="k">&gt;&lt;</span><span class="i">br</span> <span class="k">/&gt;</span>
        <span class="k">&lt;</span><span class="i">form</span> <span class="o">method</span><span class="k">="post"</span> <span class="o">action</span><span class="k">="Index.html"</span><span class="k">&gt;</span>
            <span class="k">&lt;</span><span class="i">div</span> <span class="o">id</span><span class="k">="question"</span><span class="k">&gt;&lt;/</span><span class="i">div</span><span class="k">&gt;&lt;</span><span class="i">br</span> <span class="k">/&gt;</span>
            <span class="k">&lt;</span><span class="i">input</span> <span class="o">type</span><span class="k">="button"</span> <span class="o">id</span><span class="k">="btn1"</span> <span class="k">/&gt;</span>
            <span class="k">&lt;</span><span class="i">input</span> <span class="o">type</span><span class="k">="button"</span> <span class="o">id</span><span class="k">="btn2"</span> <span class="k">/&gt;</span>
            <span class="k">&lt;</span><span class="i">input</span> <span class="o">type</span><span class="k">="button"</span> <span class="o">id</span><span class="k">="btn3"</span> <span class="k">/&gt;</span>
            <span class="k">&lt;</span><span class="i">br</span> <span class="k">/&gt;&lt;</span><span class="i">br</span> <span class="k">/&gt;&lt;</span><span class="i">br</span> <span class="k">/&gt;</span>
            Corrects: <span class="k">&lt;</span><span class="i">b</span> <span class="o">id</span><span class="k">="correctDisplay"</span><span class="k">&gt;&lt;/</span><span class="i">b</span><span class="k">&gt;</span>
        <span class="k">&lt;/</span><span class="i">form</span><span class="k">&gt;</span>
    <span class="k">&lt;/</span><span class="i">div</span><span class="k">&gt;</span>
<span class="k">&lt;/</span><span class="i">body</span><span class="k">&gt;</span>
<span class="k">&lt;/</span><span class="i">html</span><span class="k">&gt;</span></pre>

<p>Tämä on siis simppeli HTML/JavaScript-tiedosto. Nyt voit käynnistää ohjelman... (F5)</p>

<p><a href="../Readme.html">Takaisin valikkoon</a></p>

          <div class="tip" id="fs1">namespace Microsoft</div>
<div class="tip" id="fs2">val ignore : value:&#39;T -&gt; unit<br /><br />Full name: Microsoft.FSharp.Core.Operators.ignore</div>
<div class="tip" id="fs3">val typeof&lt;&#39;T&gt; : System.Type<br /><br />Full name: Microsoft.FSharp.Core.Operators.typeof</div>
<div class="tip" id="fs4">val sprintf : format:Printf.StringFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.sprintf</div>
<div class="tip" id="fs5">val log : value:&#39;T -&gt; &#39;T (requires member Log)<br /><br />Full name: Microsoft.FSharp.Core.Operators.log</div>
<div class="tip" id="fs6">namespace System</div>
<div class="tip" id="fs7">namespace Microsoft.FSharp.Data</div>
<div class="tip" id="fs8">module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs9">val filter : predicate:(&#39;T -&gt; bool) -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.filter</div>
<div class="tip" id="fs10">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;U&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.map</div>
<div class="tip" id="fs11">val toArray : source:seq&lt;&#39;T&gt; -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Seq.toArray</div>
<div class="tip" id="fs12">val fst : tuple:(&#39;T1 * &#39;T2) -&gt; &#39;T1<br /><br />Full name: Microsoft.FSharp.Core.Operators.fst</div>
<div class="tip" id="fs13">Multiple items<br />module List<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;| ( [] )<br />&#160;&#160;| ( :: ) of Head: &#39;T * Tail: &#39;T list<br />&#160;&#160;interface IEnumerable<br />&#160;&#160;interface IEnumerable&lt;&#39;T&gt;<br />&#160;&#160;member Head : &#39;T<br />&#160;&#160;member IsEmpty : bool<br />&#160;&#160;member Item : index:int -&gt; &#39;T with get<br />&#160;&#160;member Length : int<br />&#160;&#160;member Tail : &#39;T list<br />&#160;&#160;static member Cons : head:&#39;T * tail:&#39;T list -&gt; &#39;T list<br />&#160;&#160;static member Empty : &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List&lt;_&gt;</div>
<div class="tip" id="fs14">val sort : list:&#39;T list -&gt; &#39;T list (requires comparison)<br /><br />Full name: Microsoft.FSharp.Collections.List.sort</div>
<div class="tip" id="fs15">module Array<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs16">val exists : predicate:(&#39;T -&gt; bool) -&gt; array:&#39;T [] -&gt; bool<br /><br />Full name: Microsoft.FSharp.Collections.Array.exists</div>
<div class="tip" id="fs17">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; list:&#39;T list -&gt; &#39;U list<br /><br />Full name: Microsoft.FSharp.Collections.List.map</div>
<div class="tip" id="fs18">val skip : count:int -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.skip</div>
<div class="tip" id="fs19">val head : source:seq&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Collections.Seq.head</div>
<div class="tip" id="fs20">val snd : tuple:(&#39;T1 * &#39;T2) -&gt; &#39;T2<br /><br />Full name: Microsoft.FSharp.Core.Operators.snd</div>
<div class="tip" id="fs21">Multiple items<br />val int : value:&#39;T -&gt; int (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int<br /><br />--------------------<br />type int = int32<br /><br />Full name: Microsoft.FSharp.Core.int<br /><br />--------------------<br />type int&lt;&#39;Measure&gt; = int<br /><br />Full name: Microsoft.FSharp.Core.int&lt;_&gt;</div>
<div class="tip" id="fs22">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs23">type unit = Unit<br /><br />Full name: Microsoft.FSharp.Core.unit</div>
          
        </div>
        <div class="span1"></div>
      </div>
    </div>
	<br/><div style="color:gray; text-align: center;"><img alt="Creative Commons -k�ytt�lupa" style="border-width:0" src="http://i.creativecommons.org/l/by/4.0/88x31.png" /> Tuomas Hietanen, 2014, thorium(at)iki.fi, <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" style="color:gray;">Creative Commons</a></div>
  </body>
</html>